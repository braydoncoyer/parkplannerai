import{j as H}from"./jsx-runtime.D_zvdyIk.js";import{r as C,b as oe}from"./index.Da02gyCa.js";var v=[],w=[],Ve=Uint8Array,z="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(var M=0,Fe=z.length;M<Fe;++M)v[M]=z[M],w[z.charCodeAt(M)]=M;w[45]=62;w[95]=63;function Be(s){var e=s.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var t=s.indexOf("=");t===-1&&(t=e);var n=t===e?0:4-t%4;return[t,n]}function De(s,e,t){return(e+t)*3/4-t}function N(s){var e,t=Be(s),n=t[0],i=t[1],r=new Ve(De(s,n,i)),o=0,c=i>0?n-4:n,a;for(a=0;a<c;a+=4)e=w[s.charCodeAt(a)]<<18|w[s.charCodeAt(a+1)]<<12|w[s.charCodeAt(a+2)]<<6|w[s.charCodeAt(a+3)],r[o++]=e>>16&255,r[o++]=e>>8&255,r[o++]=e&255;return i===2&&(e=w[s.charCodeAt(a)]<<2|w[s.charCodeAt(a+1)]>>4,r[o++]=e&255),i===1&&(e=w[s.charCodeAt(a)]<<10|w[s.charCodeAt(a+1)]<<4|w[s.charCodeAt(a+2)]>>2,r[o++]=e>>8&255,r[o++]=e&255),r}function Ue(s){return v[s>>18&63]+v[s>>12&63]+v[s>>6&63]+v[s&63]}function We(s,e,t){for(var n,i=[],r=e;r<t;r+=3)n=(s[r]<<16&16711680)+(s[r+1]<<8&65280)+(s[r+2]&255),i.push(Ue(n));return i.join("")}function V(s){for(var e,t=s.length,n=t%3,i=[],r=16383,o=0,c=t-n;o<c;o+=r)i.push(We(s,o,o+r>c?c:o+r));return n===1?(e=s[t-1],i.push(v[e>>2]+v[e<<4&63]+"==")):n===2&&(e=(s[t-2]<<8)+s[t-1],i.push(v[e>>10]+v[e>>4&63]+v[e<<2&63]+"=")),i.join("")}function R(s){if(s===void 0)return{};if(!Re(s))throw new Error(`The arguments to a Convex function must be an object. Received: ${s}`);return s}function je(s){if(typeof s>"u")throw new Error("Client created with undefined deployment address. If you used an environment variable, check that it's set.");if(typeof s!="string")throw new Error(`Invalid deployment address: found ${s}".`);if(!(s.startsWith("http:")||s.startsWith("https:")))throw new Error(`Invalid deployment address: Must start with "https://" or "http://". Found "${s}".`);try{new URL(s)}catch{throw new Error(`Invalid deployment address: "${s}" is not a valid URL. If you believe this URL is correct, use the \`skipConvexDeploymentUrlCheck\` option to bypass this.`)}if(s.endsWith(".convex.site"))throw new Error(`Invalid deployment address: "${s}" ends with .convex.site, which is used for HTTP Actions. Convex deployment URLs typically end with .convex.cloud? If you believe this URL is correct, use the \`skipConvexDeploymentUrlCheck\` option to bypass this.`)}function Re(s){const e=typeof s=="object",t=Object.getPrototypeOf(s),n=t===null||t===Object.prototype||t?.constructor?.name==="Object";return e&&n}const Ce=!0,P=BigInt("-9223372036854775808"),ae=BigInt("9223372036854775807"),se=BigInt("0"),Je=BigInt("8"),Ke=BigInt("256");function qe(s){return Number.isNaN(s)||!Number.isFinite(s)||Object.is(s,-0)}function He(s){s<se&&(s-=P+P);let e=s.toString(16);e.length%2===1&&(e="0"+e);const t=new Uint8Array(new ArrayBuffer(8));let n=0;for(const i of e.match(/.{2}/g).reverse())t.set([parseInt(i,16)],n++),s>>=Je;return V(t)}function ze(s){const e=N(s);if(e.byteLength!==8)throw new Error(`Received ${e.byteLength} bytes, expected 8 for $integer`);let t=se,n=se;for(const i of e)t+=BigInt(i)*Ke**n,n++;return t>ae&&(t+=P+P),t}function Ge(s){if(s<P||ae<s)throw new Error(`BigInt ${s} does not fit into a 64-bit signed integer.`);const e=new ArrayBuffer(8);return new DataView(e).setBigInt64(0,s,!0),V(new Uint8Array(e))}function Xe(s){const e=N(s);if(e.byteLength!==8)throw new Error(`Received ${e.byteLength} bytes, expected 8 for $integer`);return new DataView(e.buffer).getBigInt64(0,!0)}const Ye=DataView.prototype.setBigInt64?Ge:He,Ze=DataView.prototype.getBigInt64?Xe:ze,ue=1024;function Ae(s){if(s.length>ue)throw new Error(`Field name ${s} exceeds maximum field name length ${ue}.`);if(s.startsWith("$"))throw new Error(`Field name ${s} starts with a '$', which is reserved.`);for(let e=0;e<s.length;e+=1){const t=s.charCodeAt(e);if(t<32||t>=127)throw new Error(`Field name ${s} has invalid character '${s[e]}': Field names can only contain non-control ASCII characters`)}}function x(s){if(s===null||typeof s=="boolean"||typeof s=="number"||typeof s=="string")return s;if(Array.isArray(s))return s.map(n=>x(n));if(typeof s!="object")throw new Error(`Unexpected type of ${s}`);const e=Object.entries(s);if(e.length===1){const n=e[0][0];if(n==="$bytes"){if(typeof s.$bytes!="string")throw new Error(`Malformed $bytes field on ${s}`);return N(s.$bytes).buffer}if(n==="$integer"){if(typeof s.$integer!="string")throw new Error(`Malformed $integer field on ${s}`);return Ze(s.$integer)}if(n==="$float"){if(typeof s.$float!="string")throw new Error(`Malformed $float field on ${s}`);const i=N(s.$float);if(i.byteLength!==8)throw new Error(`Received ${i.byteLength} bytes, expected 8 for $float`);const o=new DataView(i.buffer).getFloat64(0,Ce);if(!qe(o))throw new Error(`Float ${o} should be encoded as a number`);return o}if(n==="$set")throw new Error("Received a Set which is no longer supported as a Convex type.");if(n==="$map")throw new Error("Received a Map which is no longer supported as a Convex type.")}const t={};for(const[n,i]of Object.entries(s))Ae(n),t[n]=x(i);return t}const he=16384;function E(s){const e=JSON.stringify(s,(t,n)=>n===void 0?"undefined":typeof n=="bigint"?`${n.toString()}n`:n);if(e.length>he){const t="[...truncated]";let n=he-t.length;const i=e.codePointAt(n-1);return i!==void 0&&i>65535&&(n-=1),e.substring(0,n)+t}return e}function ne(s,e,t,n){if(s===void 0){const o=t&&` (present at path ${t} in original object ${E(e)})`;throw new Error(`undefined is not a valid Convex value${o}. To learn about Convex's supported types, see https://docs.convex.dev/using/types.`)}if(s===null)return s;if(typeof s=="bigint"){if(s<P||ae<s)throw new Error(`BigInt ${s} does not fit into a 64-bit signed integer.`);return{$integer:Ye(s)}}if(typeof s=="number")if(qe(s)){const o=new ArrayBuffer(8);return new DataView(o).setFloat64(0,s,Ce),{$float:V(new Uint8Array(o))}}else return s;if(typeof s=="boolean"||typeof s=="string")return s;if(s instanceof ArrayBuffer)return{$bytes:V(new Uint8Array(s))};if(Array.isArray(s))return s.map((o,c)=>ne(o,e,t+`[${c}]`));if(s instanceof Set)throw new Error(G(t,"Set",[...s],e));if(s instanceof Map)throw new Error(G(t,"Map",[...s],e));if(!Re(s)){const o=s?.constructor?.name,c=o?`${o} `:"";throw new Error(G(t,c,s,e))}const i={},r=Object.entries(s);r.sort(([o,c],[a,u])=>o===a?0:o<a?-1:1);for(const[o,c]of r)c!==void 0&&(Ae(o),i[o]=ne(c,e,t+`.${o}`));return i}function G(s,e,t,n){return s?`${e}${E(t)} is not a supported Convex type (present at path ${s} in original object ${E(n)}). To learn about Convex's supported types, see https://docs.convex.dev/using/types.`:`${e}${E(t)} is not a supported Convex type.`}function k(s){return ne(s,s,"")}var et=Object.defineProperty,tt=(s,e,t)=>e in s?et(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,X=(s,e,t)=>tt(s,typeof e!="symbol"?e+"":e,t),le,de;const st=Symbol.for("ConvexError");class ie extends(de=Error,le=st,de){constructor(e){super(typeof e=="string"?e:E(e)),X(this,"name","ConvexError"),X(this,"data"),X(this,le,!0),this.data=e}}const _e=()=>Array.from({length:4},()=>0);_e();_e();const fe="1.31.4";var nt=Object.defineProperty,it=(s,e,t)=>e in s?nt(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,ge=(s,e,t)=>it(s,typeof e!="symbol"?e+"":e,t);const rt="color:rgb(0, 145, 255)";function Ie(s){switch(s){case"query":return"Q";case"mutation":return"M";case"action":return"A";case"any":return"?"}}class Me{constructor(e){ge(this,"_onLogLineFuncs"),ge(this,"_verbose"),this._onLogLineFuncs={},this._verbose=e.verbose}addLogLineListener(e){let t=Math.random().toString(36).substring(2,15);for(let n=0;n<10&&this._onLogLineFuncs[t]!==void 0;n++)t=Math.random().toString(36).substring(2,15);return this._onLogLineFuncs[t]=e,()=>{delete this._onLogLineFuncs[t]}}logVerbose(...e){if(this._verbose)for(const t of Object.values(this._onLogLineFuncs))t("debug",`${new Date().toISOString()}`,...e)}log(...e){for(const t of Object.values(this._onLogLineFuncs))t("info",...e)}warn(...e){for(const t of Object.values(this._onLogLineFuncs))t("warn",...e)}error(...e){for(const t of Object.values(this._onLogLineFuncs))t("error",...e)}}function Oe(s){const e=new Me(s);return e.addLogLineListener((t,...n)=>{switch(t){case"debug":console.debug(...n);break;case"info":console.log(...n);break;case"warn":console.warn(...n);break;case"error":console.error(...n);break;default:console.log(...n)}}),e}function $e(s){return new Me(s)}function j(s,e,t,n,i){const r=Ie(t);if(typeof i=="object"&&(i=`ConvexError ${JSON.stringify(i.errorData,null,2)}`),e==="info"){const o=i.match(/^\[.*?\] /);if(o===null){s.error(`[CONVEX ${r}(${n})] Could not parse console.log`);return}const c=i.slice(1,o[0].length-2),a=i.slice(o[0].length);s.log(`%c[CONVEX ${r}(${n})] [${c}]`,rt,a)}else s.error(`[CONVEX ${r}(${n})] ${i}`)}function ot(s,e){const t=`[CONVEX FATAL ERROR] ${e}`;return s.error(t),new Error(t)}function $(s,e,t){return`[CONVEX ${Ie(s)}(${e})] ${t.errorMessage}
  Called by client`}function re(s,e){return e.data=s.errorData,e}function I(s){const e=s.split(":");let t,n;return e.length===1?(t=e[0],n="default"):(t=e.slice(0,e.length-1).join(":"),n=e[e.length-1]),t.endsWith(".js")&&(t=t.slice(0,-3)),`${t}:${n}`}function _(s,e){return JSON.stringify({udfPath:I(s),args:k(e)})}function ye(s,e,t){const{initialNumItems:n,id:i}=t;return JSON.stringify({type:"paginated",udfPath:I(s),args:k(e),options:k({initialNumItems:n,id:i})})}var at=Object.defineProperty,ct=(s,e,t)=>e in s?at(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,S=(s,e,t)=>ct(s,typeof e!="symbol"?e+"":e,t);class ut{constructor(){S(this,"nextQueryId"),S(this,"querySetVersion"),S(this,"querySet"),S(this,"queryIdToToken"),S(this,"identityVersion"),S(this,"auth"),S(this,"outstandingQueriesOlderThanRestart"),S(this,"outstandingAuthOlderThanRestart"),S(this,"paused"),S(this,"pendingQuerySetModifications"),this.nextQueryId=0,this.querySetVersion=0,this.identityVersion=0,this.querySet=new Map,this.queryIdToToken=new Map,this.outstandingQueriesOlderThanRestart=new Set,this.outstandingAuthOlderThanRestart=!1,this.paused=!1,this.pendingQuerySetModifications=new Map}hasSyncedPastLastReconnect(){return this.outstandingQueriesOlderThanRestart.size===0&&!this.outstandingAuthOlderThanRestart}markAuthCompletion(){this.outstandingAuthOlderThanRestart=!1}subscribe(e,t,n,i){const r=I(e),o=_(r,t),c=this.querySet.get(o);if(c!==void 0)return c.numSubscribers+=1,{queryToken:o,modification:null,unsubscribe:()=>this.removeSubscriber(o)};{const a=this.nextQueryId++,u={id:a,canonicalizedUdfPath:r,args:t,numSubscribers:1,journal:n,componentPath:i};this.querySet.set(o,u),this.queryIdToToken.set(a,o);const g=this.querySetVersion,y=this.querySetVersion+1,q={type:"Add",queryId:a,udfPath:r,args:[k(t)],journal:n,componentPath:i};return this.paused?this.pendingQuerySetModifications.set(a,q):this.querySetVersion=y,{queryToken:o,modification:{type:"ModifyQuerySet",baseVersion:g,newVersion:y,modifications:[q]},unsubscribe:()=>this.removeSubscriber(o)}}}transition(e){for(const t of e.modifications)switch(t.type){case"QueryUpdated":case"QueryFailed":{this.outstandingQueriesOlderThanRestart.delete(t.queryId);const n=t.journal;if(n!==void 0){const i=this.queryIdToToken.get(t.queryId);i!==void 0&&(this.querySet.get(i).journal=n)}break}case"QueryRemoved":{this.outstandingQueriesOlderThanRestart.delete(t.queryId);break}default:throw new Error(`Invalid modification ${t.type}`)}}queryId(e,t){const n=I(e),i=_(n,t),r=this.querySet.get(i);return r!==void 0?r.id:null}isCurrentOrNewerAuthVersion(e){return e>=this.identityVersion}getAuth(){return this.auth}setAuth(e){this.auth={tokenType:"User",value:e};const t=this.identityVersion;return this.paused||(this.identityVersion=t+1),{type:"Authenticate",baseVersion:t,...this.auth}}setAdminAuth(e,t){const n={tokenType:"Admin",value:e,impersonating:t};this.auth=n;const i=this.identityVersion;return this.paused||(this.identityVersion=i+1),{type:"Authenticate",baseVersion:i,...n}}clearAuth(){this.auth=void 0,this.markAuthCompletion();const e=this.identityVersion;return this.paused||(this.identityVersion=e+1),{type:"Authenticate",tokenType:"None",baseVersion:e}}hasAuth(){return!!this.auth}isNewAuth(e){return this.auth?.value!==e}queryPath(e){const t=this.queryIdToToken.get(e);return t?this.querySet.get(t).canonicalizedUdfPath:null}queryArgs(e){const t=this.queryIdToToken.get(e);return t?this.querySet.get(t).args:null}queryToken(e){return this.queryIdToToken.get(e)??null}queryJournal(e){return this.querySet.get(e)?.journal}restart(e){this.unpause(),this.outstandingQueriesOlderThanRestart.clear();const t=[];for(const r of this.querySet.values()){const o={type:"Add",queryId:r.id,udfPath:r.canonicalizedUdfPath,args:[k(r.args)],journal:r.journal,componentPath:r.componentPath};t.push(o),e.has(r.id)||this.outstandingQueriesOlderThanRestart.add(r.id)}this.querySetVersion=1;const n={type:"ModifyQuerySet",baseVersion:0,newVersion:1,modifications:t};if(!this.auth)return this.identityVersion=0,[n,void 0];this.outstandingAuthOlderThanRestart=!0;const i={type:"Authenticate",baseVersion:0,...this.auth};return this.identityVersion=1,[n,i]}pause(){this.paused=!0}resume(){const e=this.pendingQuerySetModifications.size>0?{type:"ModifyQuerySet",baseVersion:this.querySetVersion,newVersion:++this.querySetVersion,modifications:Array.from(this.pendingQuerySetModifications.values())}:void 0,t=this.auth!==void 0?{type:"Authenticate",baseVersion:this.identityVersion++,...this.auth}:void 0;return this.unpause(),[e,t]}unpause(){this.paused=!1,this.pendingQuerySetModifications.clear()}removeSubscriber(e){const t=this.querySet.get(e);if(t.numSubscribers>1)return t.numSubscribers-=1,null;{this.querySet.delete(e),this.queryIdToToken.delete(t.id),this.outstandingQueriesOlderThanRestart.delete(t.id);const n=this.querySetVersion,i=this.querySetVersion+1,r={type:"Remove",queryId:t.id};return this.paused?this.pendingQuerySetModifications.has(t.id)?this.pendingQuerySetModifications.delete(t.id):this.pendingQuerySetModifications.set(t.id,r):this.querySetVersion=i,{type:"ModifyQuerySet",baseVersion:n,newVersion:i,modifications:[r]}}}}var ht=Object.defineProperty,lt=(s,e,t)=>e in s?ht(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,D=(s,e,t)=>lt(s,typeof e!="symbol"?e+"":e,t);class dt{constructor(e,t){this.logger=e,this.markConnectionStateDirty=t,D(this,"inflightRequests"),D(this,"requestsOlderThanRestart"),D(this,"inflightMutationsCount",0),D(this,"inflightActionsCount",0),this.inflightRequests=new Map,this.requestsOlderThanRestart=new Set}request(e,t){const n=new Promise(i=>{const r=t?"Requested":"NotSent";this.inflightRequests.set(e.requestId,{message:e,status:{status:r,requestedAt:new Date,onResult:i}}),e.type==="Mutation"?this.inflightMutationsCount++:e.type==="Action"&&this.inflightActionsCount++});return this.markConnectionStateDirty(),n}onResponse(e){const t=this.inflightRequests.get(e.requestId);if(t===void 0||t.status.status==="Completed")return null;const n=t.message.type==="Mutation"?"mutation":"action",i=t.message.udfPath;for(const a of e.logLines)j(this.logger,"info",n,i,a);const r=t.status;let o,c;if(e.success)o={success:!0,logLines:e.logLines,value:x(e.result)},c=()=>r.onResult(o);else{const a=e.result,{errorData:u}=e;j(this.logger,"error",n,i,a),o={success:!1,errorMessage:a,errorData:u!==void 0?x(u):void 0,logLines:e.logLines},c=()=>r.onResult(o)}return e.type==="ActionResponse"||!e.success?(c(),this.inflightRequests.delete(e.requestId),this.requestsOlderThanRestart.delete(e.requestId),t.message.type==="Action"?this.inflightActionsCount--:t.message.type==="Mutation"&&this.inflightMutationsCount--,this.markConnectionStateDirty(),{requestId:e.requestId,result:o}):(t.status={status:"Completed",result:o,ts:e.ts,onResolve:c},null)}removeCompleted(e){const t=new Map;for(const[n,i]of this.inflightRequests.entries()){const r=i.status;r.status==="Completed"&&r.ts.lessThanOrEqual(e)&&(r.onResolve(),t.set(n,r.result),i.message.type==="Mutation"?this.inflightMutationsCount--:i.message.type==="Action"&&this.inflightActionsCount--,this.inflightRequests.delete(n),this.requestsOlderThanRestart.delete(n))}return t.size>0&&this.markConnectionStateDirty(),t}restart(){this.requestsOlderThanRestart=new Set(this.inflightRequests.keys());const e=[];for(const[t,n]of this.inflightRequests){if(n.status.status==="NotSent"){n.status.status="Requested",e.push(n.message);continue}if(n.message.type==="Mutation")e.push(n.message);else if(n.message.type==="Action"){if(this.inflightRequests.delete(t),this.requestsOlderThanRestart.delete(t),this.inflightActionsCount--,n.status.status==="Completed")throw new Error("Action should never be in 'Completed' state");n.status.onResult({success:!1,errorMessage:"Connection lost while action was in flight",logLines:[]})}}return this.markConnectionStateDirty(),e}resume(){const e=[];for(const[,t]of this.inflightRequests)if(t.status.status==="NotSent"){t.status.status="Requested",e.push(t.message);continue}return e}hasIncompleteRequests(){for(const e of this.inflightRequests.values())if(e.status.status==="Requested")return!0;return!1}hasInflightRequests(){return this.inflightRequests.size>0}hasSyncedPastLastReconnect(){return this.requestsOlderThanRestart.size===0}timeOfOldestInflightRequest(){if(this.inflightRequests.size===0)return null;let e=Date.now();for(const t of this.inflightRequests.values())t.status.status!=="Completed"&&t.status.requestedAt.getTime()<e&&(e=t.status.requestedAt.getTime());return new Date(e)}inflightMutations(){return this.inflightMutationsCount}inflightActions(){return this.inflightActionsCount}}const F=Symbol.for("functionName"),Pe=Symbol.for("toReferencePath");function ft(s){return s[Pe]??null}function gt(s){return s.startsWith("function://")}function yt(s){let e;if(typeof s=="string")gt(s)?e={functionHandle:s}:e={name:s};else if(s[F])e={name:s[F]};else{const t=ft(s);if(!t)throw new Error(`${s} is not a functionReference`);e={reference:t}}return e}function b(s){const e=yt(s);if(e.name===void 0)throw e.functionHandle!==void 0?new Error(`Expected function reference like "api.file.func" or "internal.file.func", but received function handle ${e.functionHandle}`):e.reference!==void 0?new Error(`Expected function reference in the current component like "api.file.func" or "internal.file.func", but received reference ${e.reference}`):new Error(`Expected function reference like "api.file.func" or "internal.file.func", but received ${JSON.stringify(e)}`);if(typeof s=="string")return s;const t=s[F];if(!t)throw new Error(`${s} is not a functionReference`);return t}function pt(s){return{[F]:s}}function xe(s=[]){const e={get(t,n){if(typeof n=="string"){const i=[...s,n];return xe(i)}else if(n===F){if(s.length<2){const o=["api",...s].join(".");throw new Error(`API path is expected to be of the form \`api.moduleName.functionName\`. Found: \`${o}\``)}const i=s.slice(0,-1).join("/"),r=s[s.length-1];return r==="default"?i:i+":"+r}else return n===Symbol.toStringTag?"FunctionReference":void 0}};return new Proxy({},e)}const mt=xe();var wt=Object.defineProperty,bt=(s,e,t)=>e in s?wt(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,J=(s,e,t)=>bt(s,typeof e!="symbol"?e+"":e,t);class B{constructor(e){J(this,"queryResults"),J(this,"modifiedQueries"),this.queryResults=e,this.modifiedQueries=[]}getQuery(e,...t){const n=R(t[0]),i=b(e),r=this.queryResults.get(_(i,n));if(r!==void 0)return B.queryValue(r.result)}getAllQueries(e){const t=[],n=b(e);for(const i of this.queryResults.values())i.udfPath===I(n)&&t.push({args:i.args,value:B.queryValue(i.result)});return t}setQuery(e,t,n){const i=R(t),r=b(e),o=_(r,i);let c;n===void 0?c=void 0:c={success:!0,value:n,logLines:[]};const a={udfPath:r,args:i,result:c};this.queryResults.set(o,a),this.modifiedQueries.push(o)}static queryValue(e){if(e!==void 0)return e.success?e.value:void 0}}class St{constructor(){J(this,"queryResults"),J(this,"optimisticUpdates"),this.queryResults=new Map,this.optimisticUpdates=[]}ingestQueryResultsFromServer(e,t){this.optimisticUpdates=this.optimisticUpdates.filter(o=>!t.has(o.mutationId));const n=this.queryResults;this.queryResults=new Map(e);const i=new B(this.queryResults);for(const o of this.optimisticUpdates)o.update(i);const r=[];for(const[o,c]of this.queryResults){const a=n.get(o);(a===void 0||a.result!==c.result)&&r.push(o)}return r}applyOptimisticUpdate(e,t){this.optimisticUpdates.push({update:e,mutationId:t});const n=new B(this.queryResults);return e(n),n.modifiedQueries}rawQueryResult(e){const t=this.queryResults.get(e);if(t!==void 0)return t.result}queryResult(e){const t=this.queryResults.get(e);if(t===void 0)return;const n=t.result;if(n!==void 0){if(n.success)return n.value;throw n.errorData!==void 0?re(n,new ie($("query",t.udfPath,n))):new Error($("query",t.udfPath,n))}}hasQueryResult(e){return this.queryResults.get(e)!==void 0}queryLogs(e){return this.queryResults.get(e)?.result?.logLines}}var vt=Object.defineProperty,kt=(s,e,t)=>e in s?vt(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Y=(s,e,t)=>kt(s,typeof e!="symbol"?e+"":e,t);class p{constructor(e,t){Y(this,"low"),Y(this,"high"),Y(this,"__isUnsignedLong__"),this.low=e|0,this.high=t|0,this.__isUnsignedLong__=!0}static isLong(e){return(e&&e.__isUnsignedLong__)===!0}static fromBytesLE(e){return new p(e[0]|e[1]<<8|e[2]<<16|e[3]<<24,e[4]|e[5]<<8|e[6]<<16|e[7]<<24)}toBytesLE(){const e=this.high,t=this.low;return[t&255,t>>>8&255,t>>>16&255,t>>>24,e&255,e>>>8&255,e>>>16&255,e>>>24]}static fromNumber(e){return isNaN(e)||e<0?pe:e>=Tt?Rt:new p(e%L|0,e/L|0)}toString(){return(BigInt(this.high)*BigInt(L)+BigInt(this.low)).toString()}equals(e){return p.isLong(e)||(e=p.fromValue(e)),this.high>>>31===1&&e.high>>>31===1?!1:this.high===e.high&&this.low===e.low}notEquals(e){return!this.equals(e)}comp(e){return p.isLong(e)||(e=p.fromValue(e)),this.equals(e)?0:e.high>>>0>this.high>>>0||e.high===this.high&&e.low>>>0>this.low>>>0?-1:1}lessThanOrEqual(e){return this.comp(e)<=0}static fromValue(e){return typeof e=="number"?p.fromNumber(e):new p(e.low,e.high)}}const pe=new p(0,0),me=65536,L=me*me,Tt=L*L,Rt=new p(-1,-1);var Ct=Object.defineProperty,qt=(s,e,t)=>e in s?Ct(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,U=(s,e,t)=>qt(s,typeof e!="symbol"?e+"":e,t);class we{constructor(e,t){U(this,"version"),U(this,"remoteQuerySet"),U(this,"queryPath"),U(this,"logger"),this.version={querySet:0,ts:p.fromNumber(0),identity:0},this.remoteQuerySet=new Map,this.queryPath=e,this.logger=t}transition(e){const t=e.startVersion;if(this.version.querySet!==t.querySet||this.version.ts.notEquals(t.ts)||this.version.identity!==t.identity)throw new Error(`Invalid start version: ${t.ts.toString()}:${t.querySet}:${t.identity}, transitioning from ${this.version.ts.toString()}:${this.version.querySet}:${this.version.identity}`);for(const n of e.modifications)switch(n.type){case"QueryUpdated":{const i=this.queryPath(n.queryId);if(i)for(const o of n.logLines)j(this.logger,"info","query",i,o);const r=x(n.value??null);this.remoteQuerySet.set(n.queryId,{success:!0,value:r,logLines:n.logLines});break}case"QueryFailed":{const i=this.queryPath(n.queryId);if(i)for(const o of n.logLines)j(this.logger,"info","query",i,o);const{errorData:r}=n;this.remoteQuerySet.set(n.queryId,{success:!1,errorMessage:n.errorMessage,errorData:r!==void 0?x(r):void 0,logLines:n.logLines});break}case"QueryRemoved":{this.remoteQuerySet.delete(n.queryId);break}default:throw new Error(`Invalid modification ${n.type}`)}this.version=e.endVersion}remoteQueryResults(){return this.remoteQuerySet}timestamp(){return this.version.ts}}function Z(s){const e=N(s);return p.fromBytesLE(Array.from(e))}function At(s){const e=new Uint8Array(s.toBytesLE());return V(e)}function be(s){switch(s.type){case"FatalError":case"AuthError":case"ActionResponse":case"TransitionChunk":case"Ping":return{...s};case"MutationResponse":return s.success?{...s,ts:Z(s.ts)}:{...s};case"Transition":return{...s,startVersion:{...s.startVersion,ts:Z(s.startVersion.ts)},endVersion:{...s.endVersion,ts:Z(s.endVersion.ts)}}}}function _t(s){switch(s.type){case"Authenticate":case"ModifyQuerySet":case"Mutation":case"Action":case"Event":return{...s};case"Connect":return s.maxObservedTimestamp!==void 0?{...s,maxObservedTimestamp:At(s.maxObservedTimestamp)}:{...s,maxObservedTimestamp:void 0}}}var It=Object.defineProperty,Mt=(s,e,t)=>e in s?It(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,d=(s,e,t)=>Mt(s,typeof e!="symbol"?e+"":e,t);const Ot=1e3,$t=1001,Pt=1005,xt=4040;let W;function O(){return W===void 0&&(W=Date.now()),typeof performance>"u"||!performance.now?Date.now():Math.round(W+performance.now())}function Se(){return`t=${Math.round((O()-W)/100)/10}s`}const Qe={InternalServerError:{timeout:1e3},SubscriptionsWorkerFullError:{timeout:3e3},TooManyConcurrentRequests:{timeout:3e3},CommitterFullError:{timeout:3e3},AwsTooManyRequestsException:{timeout:3e3},ExecuteFullError:{timeout:3e3},SystemTimeoutError:{timeout:3e3},ExpiredInQueue:{timeout:3e3},VectorIndexesUnavailable:{timeout:1e3},SearchIndexesUnavailable:{timeout:1e3},TableSummariesUnavailable:{timeout:1e3},VectorIndexTooLarge:{timeout:3e3},SearchIndexTooLarge:{timeout:3e3},TooManyWritesInTimePeriod:{timeout:3e3}};function Qt(s){if(s===void 0)return"Unknown";for(const e of Object.keys(Qe))if(s.startsWith(e))return e;return"Unknown"}class Et{constructor(e,t,n,i,r,o){this.markConnectionStateDirty=r,this.debug=o,d(this,"socket"),d(this,"connectionCount"),d(this,"_hasEverConnected",!1),d(this,"lastCloseReason"),d(this,"transitionChunkBuffer",null),d(this,"defaultInitialBackoff"),d(this,"maxBackoff"),d(this,"retries"),d(this,"serverInactivityThreshold"),d(this,"reconnectDueToServerInactivityTimeout"),d(this,"scheduledReconnect",null),d(this,"networkOnlineHandler",null),d(this,"pendingNetworkRecoveryInfo",null),d(this,"uri"),d(this,"onOpen"),d(this,"onResume"),d(this,"onMessage"),d(this,"webSocketConstructor"),d(this,"logger"),d(this,"onServerDisconnectError"),this.webSocketConstructor=n,this.socket={state:"disconnected"},this.connectionCount=0,this.lastCloseReason="InitialConnect",this.defaultInitialBackoff=1e3,this.maxBackoff=16e3,this.retries=0,this.serverInactivityThreshold=6e4,this.reconnectDueToServerInactivityTimeout=null,this.uri=e,this.onOpen=t.onOpen,this.onResume=t.onResume,this.onMessage=t.onMessage,this.onServerDisconnectError=t.onServerDisconnectError,this.logger=i,this.setupNetworkListener(),this.connect()}setSocketState(e){this.socket=e,this._logVerbose(`socket state changed: ${this.socket.state}, paused: ${"paused"in this.socket?this.socket.paused:void 0}`),this.markConnectionStateDirty()}setupNetworkListener(){typeof window>"u"||typeof window.addEventListener!="function"||this.networkOnlineHandler===null&&(this.networkOnlineHandler=()=>{this._logVerbose("network online event detected"),this.tryReconnectImmediately()},window.addEventListener("online",this.networkOnlineHandler),this._logVerbose("network online event listener registered"))}cleanupNetworkListener(){this.networkOnlineHandler&&typeof window<"u"&&typeof window.removeEventListener=="function"&&(window.removeEventListener("online",this.networkOnlineHandler),this.networkOnlineHandler=null,this._logVerbose("network online event listener removed"))}assembleTransition(e){if(e.partNumber<0||e.partNumber>=e.totalParts||e.totalParts===0||this.transitionChunkBuffer&&(this.transitionChunkBuffer.totalParts!==e.totalParts||this.transitionChunkBuffer.transitionId!==e.transitionId))throw this.transitionChunkBuffer=null,new Error("Invalid TransitionChunk");if(this.transitionChunkBuffer===null&&(this.transitionChunkBuffer={chunks:[],totalParts:e.totalParts,transitionId:e.transitionId}),e.partNumber!==this.transitionChunkBuffer.chunks.length){const t=this.transitionChunkBuffer.chunks.length;throw this.transitionChunkBuffer=null,new Error(`TransitionChunk received out of order: expected part ${t}, got ${e.partNumber}`)}if(this.transitionChunkBuffer.chunks.push(e.chunk),this.transitionChunkBuffer.chunks.length===e.totalParts){const t=this.transitionChunkBuffer.chunks.join("");this.transitionChunkBuffer=null;const n=be(JSON.parse(t));if(n.type!=="Transition")throw new Error(`Expected Transition, got ${n.type} after assembling chunks`);return n}return null}connect(){if(this.socket.state==="terminated")return;if(this.socket.state!=="disconnected"&&this.socket.state!=="stopped")throw new Error("Didn't start connection from disconnected state: "+this.socket.state);const e=new this.webSocketConstructor(this.uri);this._logVerbose("constructed WebSocket"),this.setSocketState({state:"connecting",ws:e,paused:"no"}),this.resetServerInactivityTimeout(),e.onopen=()=>{if(this.logger.logVerbose("begin ws.onopen"),this.socket.state!=="connecting")throw new Error("onopen called with socket not in connecting state");if(this.setSocketState({state:"ready",ws:e,paused:this.socket.paused==="yes"?"uninitialized":"no"}),this.resetServerInactivityTimeout(),this.socket.paused==="no"&&(this._hasEverConnected=!0,this.onOpen({connectionCount:this.connectionCount,lastCloseReason:this.lastCloseReason,clientTs:O()})),this.lastCloseReason!=="InitialConnect"&&(this.lastCloseReason?this.logger.log("WebSocket reconnected at",Se(),"after disconnect due to",this.lastCloseReason):this.logger.log("WebSocket reconnected at",Se())),this.connectionCount+=1,this.lastCloseReason=null,this.pendingNetworkRecoveryInfo!==null){const{timeSavedMs:t}=this.pendingNetworkRecoveryInfo;this.pendingNetworkRecoveryInfo=null,this.sendMessage({type:"Event",eventType:"NetworkRecoveryReconnect",event:{timeSavedMs:t}}),this.logger.log(`Network recovery reconnect saved ~${Math.round(t/1e3)}s of waiting`)}},e.onerror=t=>{this.transitionChunkBuffer=null;const n=t.message;n&&this.logger.log(`WebSocket error message: ${n}`)},e.onmessage=t=>{this.resetServerInactivityTimeout();const n=t.data.length;let i=be(JSON.parse(t.data));if(this._logVerbose(`received ws message with type ${i.type}`),i.type==="Ping")return;if(i.type==="TransitionChunk"){const o=this.assembleTransition(i);if(!o)return;i=o,this._logVerbose(`assembled full ws message of type ${i.type}`)}this.transitionChunkBuffer!==null&&(this.transitionChunkBuffer=null,this.logger.log(`Received unexpected ${i.type} while buffering TransitionChunks`)),i.type==="Transition"&&this.reportLargeTransition({messageLength:n,transition:i}),this.onMessage(i).hasSyncedPastLastReconnect&&(this.retries=0,this.markConnectionStateDirty())},e.onclose=t=>{if(this._logVerbose("begin ws.onclose"),this.transitionChunkBuffer=null,this.lastCloseReason===null&&(this.lastCloseReason=t.reason||`closed with code ${t.code}`),t.code!==Ot&&t.code!==$t&&t.code!==Pt&&t.code!==xt){let i=`WebSocket closed with code ${t.code}`;t.reason&&(i+=`: ${t.reason}`),this.logger.log(i),this.onServerDisconnectError&&t.reason&&this.onServerDisconnectError(i)}const n=Qt(t.reason);this.scheduleReconnect(n)}}socketState(){return this.socket.state}sendMessage(e){const t={type:e.type,...e.type==="Authenticate"&&e.tokenType==="User"?{value:`...${e.value.slice(-7)}`}:{}};if(this.socket.state==="ready"&&this.socket.paused==="no"){const n=_t(e),i=JSON.stringify(n);let r=!1;try{this.socket.ws.send(i),r=!0}catch(o){this.logger.log(`Failed to send message on WebSocket, reconnecting: ${o}`),this.closeAndReconnect("FailedToSendMessage")}return this._logVerbose(`${r?"sent":"failed to send"} message with type ${e.type}: ${JSON.stringify(t)}`),!0}return this._logVerbose(`message not sent (socket state: ${this.socket.state}, paused: ${"paused"in this.socket?this.socket.paused:void 0}): ${JSON.stringify(t)}`),!1}resetServerInactivityTimeout(){this.socket.state!=="terminated"&&(this.reconnectDueToServerInactivityTimeout!==null&&(clearTimeout(this.reconnectDueToServerInactivityTimeout),this.reconnectDueToServerInactivityTimeout=null),this.reconnectDueToServerInactivityTimeout=setTimeout(()=>{this.closeAndReconnect("InactiveServer")},this.serverInactivityThreshold))}scheduleReconnect(e){this.scheduledReconnect&&(clearTimeout(this.scheduledReconnect.timeout),this.scheduledReconnect=null),this.socket={state:"disconnected"};const t=this.nextBackoff(e);this.markConnectionStateDirty(),this.logger.log(`Attempting reconnect in ${Math.round(t)}ms`);const n=O(),i=setTimeout(()=>{this.scheduledReconnect?.timeout===i&&(this.scheduledReconnect=null,this.connect())},t);this.scheduledReconnect={timeout:i,scheduledAt:n,backoffMs:t}}closeAndReconnect(e){switch(this._logVerbose(`begin closeAndReconnect with reason ${e}`),this.socket.state){case"disconnected":case"terminated":case"stopped":return;case"connecting":case"ready":{this.lastCloseReason=e,this.close(),this.scheduleReconnect("client");return}default:this.socket}}close(){switch(this.transitionChunkBuffer=null,this.socket.state){case"disconnected":case"terminated":case"stopped":return Promise.resolve();case"connecting":{const e=this.socket.ws;return e.onmessage=t=>{this._logVerbose("Ignoring message received after close")},new Promise(t=>{e.onclose=()=>{this._logVerbose("Closed after connecting"),t()},e.onopen=()=>{this._logVerbose("Opened after connecting"),e.close()}})}case"ready":{this._logVerbose("ws.close called");const e=this.socket.ws;e.onmessage=n=>{this._logVerbose("Ignoring message received after close")};const t=new Promise(n=>{e.onclose=()=>{n()}});return e.close(),t}default:return this.socket,Promise.resolve()}}terminate(){switch(this.reconnectDueToServerInactivityTimeout&&clearTimeout(this.reconnectDueToServerInactivityTimeout),this.scheduledReconnect&&(clearTimeout(this.scheduledReconnect.timeout),this.scheduledReconnect=null),this.cleanupNetworkListener(),this.socket.state){case"terminated":case"stopped":case"disconnected":case"connecting":case"ready":{const e=this.close();return this.setSocketState({state:"terminated"}),e}default:throw this.socket,new Error(`Invalid websocket state: ${this.socket.state}`)}}stop(){switch(this.socket.state){case"terminated":return Promise.resolve();case"connecting":case"stopped":case"disconnected":case"ready":{this.cleanupNetworkListener();const e=this.close();return this.socket={state:"stopped"},e}default:return this.socket,Promise.resolve()}}tryRestart(){switch(this.socket.state){case"stopped":break;case"terminated":case"connecting":case"ready":case"disconnected":this.logger.logVerbose("Restart called without stopping first");return;default:this.socket}this.setupNetworkListener(),this.connect()}pause(){switch(this.socket.state){case"disconnected":case"stopped":case"terminated":return;case"connecting":case"ready":{this.socket={...this.socket,paused:"yes"};return}default:{this.socket;return}}}tryReconnectImmediately(){if(this._logVerbose("tryReconnectImmediately called"),this.socket.state!=="disconnected"){this._logVerbose(`tryReconnectImmediately called but socket state is ${this.socket.state}, no action taken`);return}let e=null;if(this.scheduledReconnect){const t=O()-this.scheduledReconnect.scheduledAt;e=Math.max(0,this.scheduledReconnect.backoffMs-t),this._logVerbose(`would have waited ${Math.round(e)}ms more (backoff was ${Math.round(this.scheduledReconnect.backoffMs)}ms, elapsed ${Math.round(t)}ms)`),clearTimeout(this.scheduledReconnect.timeout),this.scheduledReconnect=null,this._logVerbose("canceled scheduled reconnect")}this.logger.log("Network recovery detected, reconnecting immediately"),this.pendingNetworkRecoveryInfo=e!==null?{timeSavedMs:e}:null,this.connect()}resume(){switch(this.socket.state){case"connecting":this.socket={...this.socket,paused:"no"};return;case"ready":this.socket.paused==="uninitialized"?(this.socket={...this.socket,paused:"no"},this.onOpen({connectionCount:this.connectionCount,lastCloseReason:this.lastCloseReason,clientTs:O()})):this.socket.paused==="yes"&&(this.socket={...this.socket,paused:"no"},this.onResume());return;case"terminated":case"stopped":case"disconnected":return;default:this.socket}this.connect()}connectionState(){return{isConnected:this.socket.state==="ready",hasEverConnected:this._hasEverConnected,connectionCount:this.connectionCount,connectionRetries:this.retries}}_logVerbose(e){this.logger.logVerbose(e)}nextBackoff(e){const n=(e==="client"?100:e==="Unknown"?this.defaultInitialBackoff:Qe[e].timeout)*Math.pow(2,this.retries);this.retries+=1;const i=Math.min(n,this.maxBackoff),r=i*(Math.random()-.5);return i+r}reportLargeTransition({transition:e,messageLength:t}){if(e.clientClockSkew===void 0||e.serverTs===void 0)return;const n=O()-e.clientClockSkew-e.serverTs/1e6,i=`${Math.round(n)}ms`,r=`${Math.round(t/1e4)/100}MB`,o=t/(n/1e3),c=`${Math.round(o/1e4)/100}MB per second`;this._logVerbose(`received ${r} transition in ${i} at ${c}`),t>2e7?this.logger.log(`received query results totaling more that 20MB (${r}) which will take a long time to download on slower connections`):n>2e4&&this.logger.log(`received query results totaling ${r} which took more than 20s to arrive (${i})`),this.debug&&this.sendMessage({type:"Event",eventType:"ClientReceivedTransition",event:{transitionTransitTime:n,messageLength:t}})}}function Lt(){return Nt()}function Nt(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,s=>{const e=Math.random()*16|0;return(s==="x"?e:e&3|8).toString(16)})}class Q extends Error{}Q.prototype.name="InvalidTokenError";function Vt(s){return decodeURIComponent(atob(s).replace(/(.)/g,(e,t)=>{let n=t.charCodeAt(0).toString(16).toUpperCase();return n.length<2&&(n="0"+n),"%"+n}))}function Ft(s){let e=s.replace(/-/g,"+").replace(/_/g,"/");switch(e.length%4){case 0:break;case 2:e+="==";break;case 3:e+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return Vt(e)}catch{return atob(e)}}function Ee(s,e){if(typeof s!="string")throw new Q("Invalid token specified: must be a string");e||(e={});const t=e.header===!0?0:1,n=s.split(".")[t];if(typeof n!="string")throw new Q(`Invalid token specified: missing part #${t+1}`);let i;try{i=Ft(n)}catch(r){throw new Q(`Invalid token specified: invalid base64 for part #${t+1} (${r.message})`)}try{return JSON.parse(i)}catch(r){throw new Q(`Invalid token specified: invalid json for part #${t+1} (${r.message})`)}}var Bt=Object.defineProperty,Dt=(s,e,t)=>e in s?Bt(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,m=(s,e,t)=>Dt(s,typeof e!="symbol"?e+"":e,t);const Ut=480*60*60*1e3,ve=2;class Wt{constructor(e,t,n){m(this,"authState",{state:"noAuth"}),m(this,"configVersion",0),m(this,"syncState"),m(this,"authenticate"),m(this,"stopSocket"),m(this,"tryRestartSocket"),m(this,"pauseSocket"),m(this,"resumeSocket"),m(this,"clearAuth"),m(this,"logger"),m(this,"refreshTokenLeewaySeconds"),m(this,"tokenConfirmationAttempts",0),this.syncState=e,this.authenticate=t.authenticate,this.stopSocket=t.stopSocket,this.tryRestartSocket=t.tryRestartSocket,this.pauseSocket=t.pauseSocket,this.resumeSocket=t.resumeSocket,this.clearAuth=t.clearAuth,this.logger=n.logger,this.refreshTokenLeewaySeconds=n.refreshTokenLeewaySeconds}async setConfig(e,t){this.resetAuthState(),this._logVerbose("pausing WS for auth token fetch"),this.pauseSocket();const n=await this.fetchTokenAndGuardAgainstRace(e,{forceRefreshToken:!1});n.isFromOutdatedConfig||(n.value?(this.setAuthState({state:"waitingForServerConfirmationOfCachedToken",config:{fetchToken:e,onAuthChange:t},hasRetried:!1}),this.authenticate(n.value)):(this.setAuthState({state:"initialRefetch",config:{fetchToken:e,onAuthChange:t}}),await this.refetchToken()),this._logVerbose("resuming WS after auth token fetch"),this.resumeSocket())}onTransition(e){if(this.syncState.isCurrentOrNewerAuthVersion(e.endVersion.identity)&&!(e.endVersion.identity<=e.startVersion.identity)){if(this.authState.state==="waitingForServerConfirmationOfCachedToken"){this._logVerbose("server confirmed auth token is valid"),this.refetchToken(),this.authState.config.onAuthChange(!0);return}this.authState.state==="waitingForServerConfirmationOfFreshToken"&&(this._logVerbose("server confirmed new auth token is valid"),this.scheduleTokenRefetch(this.authState.token),this.tokenConfirmationAttempts=0,this.authState.hadAuth||this.authState.config.onAuthChange(!0))}}onAuthError(e){if(e.authUpdateAttempted===!1&&(this.authState.state==="waitingForServerConfirmationOfFreshToken"||this.authState.state==="waitingForServerConfirmationOfCachedToken")){this._logVerbose("ignoring non-auth token expired error");return}const{baseVersion:t}=e;if(!this.syncState.isCurrentOrNewerAuthVersion(t+1)){this._logVerbose("ignoring auth error for previous auth attempt");return}this.tryToReauthenticate(e)}async tryToReauthenticate(e){if(this._logVerbose(`attempting to reauthenticate: ${e.error}`),this.authState.state==="noAuth"||this.authState.state==="waitingForServerConfirmationOfFreshToken"&&this.tokenConfirmationAttempts>=ve){this.logger.error(`Failed to authenticate: "${e.error}", check your server auth config`),this.syncState.hasAuth()&&this.syncState.clearAuth(),this.authState.state!=="noAuth"&&this.setAndReportAuthFailed(this.authState.config.onAuthChange);return}this.authState.state==="waitingForServerConfirmationOfFreshToken"&&(this.tokenConfirmationAttempts++,this._logVerbose(`retrying reauthentication, ${ve-this.tokenConfirmationAttempts} attempts remaining`)),await this.stopSocket();const t=await this.fetchTokenAndGuardAgainstRace(this.authState.config.fetchToken,{forceRefreshToken:!0});t.isFromOutdatedConfig||(t.value&&this.syncState.isNewAuth(t.value)?(this.authenticate(t.value),this.setAuthState({state:"waitingForServerConfirmationOfFreshToken",config:this.authState.config,token:t.value,hadAuth:this.authState.state==="notRefetching"||this.authState.state==="waitingForScheduledRefetch"})):(this._logVerbose("reauthentication failed, could not fetch a new token"),this.syncState.hasAuth()&&this.syncState.clearAuth(),this.setAndReportAuthFailed(this.authState.config.onAuthChange)),this.tryRestartSocket())}async refetchToken(){if(this.authState.state==="noAuth")return;this._logVerbose("refetching auth token");const e=await this.fetchTokenAndGuardAgainstRace(this.authState.config.fetchToken,{forceRefreshToken:!0});e.isFromOutdatedConfig||(e.value?this.syncState.isNewAuth(e.value)?(this.setAuthState({state:"waitingForServerConfirmationOfFreshToken",hadAuth:this.syncState.hasAuth(),token:e.value,config:this.authState.config}),this.authenticate(e.value)):this.setAuthState({state:"notRefetching",config:this.authState.config}):(this._logVerbose("refetching token failed"),this.syncState.hasAuth()&&this.clearAuth(),this.setAndReportAuthFailed(this.authState.config.onAuthChange)),this._logVerbose("restarting WS after auth token fetch (if currently stopped)"),this.tryRestartSocket())}scheduleTokenRefetch(e){if(this.authState.state==="noAuth")return;const t=this.decodeToken(e);if(!t){this.logger.error("Auth token is not a valid JWT, cannot refetch the token");return}const{iat:n,exp:i}=t;if(!n||!i){this.logger.error("Auth token does not have required fields, cannot refetch the token");return}const r=i-n;if(r<=2){this.logger.error("Auth token does not live long enough, cannot refetch the token");return}let o=Math.min(Ut,(r-this.refreshTokenLeewaySeconds)*1e3);o<=0&&(this.logger.warn(`Refetching auth token immediately, configured leeway ${this.refreshTokenLeewaySeconds}s is larger than the token's lifetime ${r}s`),o=0);const c=setTimeout(()=>{this._logVerbose("running scheduled token refetch"),this.refetchToken()},o);this.setAuthState({state:"waitingForScheduledRefetch",refetchTokenTimeoutId:c,config:this.authState.config}),this._logVerbose(`scheduled preemptive auth token refetching in ${o}ms`)}async fetchTokenAndGuardAgainstRace(e,t){const n=++this.configVersion;this._logVerbose(`fetching token with config version ${n}`);const i=await e(t);return this.configVersion!==n?(this._logVerbose(`stale config version, expected ${n}, got ${this.configVersion}`),{isFromOutdatedConfig:!0}):{isFromOutdatedConfig:!1,value:i}}stop(){this.resetAuthState(),this.configVersion++,this._logVerbose(`config version bumped to ${this.configVersion}`)}setAndReportAuthFailed(e){e(!1),this.resetAuthState()}resetAuthState(){this.setAuthState({state:"noAuth"})}setAuthState(e){const t=e.state==="waitingForServerConfirmationOfFreshToken"?{hadAuth:e.hadAuth,state:e.state,token:`...${e.token.slice(-7)}`}:{state:e.state};switch(this._logVerbose(`setting auth state to ${JSON.stringify(t)}`),e.state){case"waitingForScheduledRefetch":case"notRefetching":case"noAuth":this.tokenConfirmationAttempts=0;break}this.authState.state==="waitingForScheduledRefetch"&&(clearTimeout(this.authState.refetchTokenTimeoutId),this.syncState.markAuthCompletion()),this.authState=e}decodeToken(e){try{return Ee(e)}catch(t){return this._logVerbose(`Error decoding token: ${t instanceof Error?t.message:"Unknown error"}`),null}}_logVerbose(e){this.logger.logVerbose(`${e} [v${this.configVersion}]`)}}const jt=["convexClientConstructed","convexWebSocketOpen","convexFirstMessageReceived"];function Jt(s,e){const t={sessionId:e};typeof performance>"u"||!performance.mark||performance.mark(s,{detail:t})}function Kt(s){let e=s.name.slice(6);return e=e.charAt(0).toLowerCase()+e.slice(1),{name:e,startTime:s.startTime}}function Ht(s){if(typeof performance>"u"||!performance.getEntriesByName)return[];const e=[];for(const t of jt){const n=performance.getEntriesByName(t).filter(i=>i.entryType==="mark").filter(i=>i.detail.sessionId===s);e.push(...n)}return e.map(Kt)}var zt=Object.defineProperty,Gt=(s,e,t)=>e in s?zt(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,f=(s,e,t)=>Gt(s,typeof e!="symbol"?e+"":e,t);class Xt{constructor(e,t,n){if(f(this,"address"),f(this,"state"),f(this,"requestManager"),f(this,"webSocketManager"),f(this,"authenticationManager"),f(this,"remoteQuerySet"),f(this,"optimisticQueryResults"),f(this,"_transitionHandlerCounter",0),f(this,"_nextRequestId"),f(this,"_onTransitionFns",new Map),f(this,"_sessionId"),f(this,"firstMessageReceived",!1),f(this,"debug"),f(this,"logger"),f(this,"maxObservedTimestamp"),f(this,"connectionStateSubscribers",new Map),f(this,"nextConnectionStateSubscriberId",0),f(this,"_lastPublishedConnectionState"),f(this,"markConnectionStateDirty",()=>{Promise.resolve().then(()=>{const h=this.connectionState();if(JSON.stringify(h)!==JSON.stringify(this._lastPublishedConnectionState)){this._lastPublishedConnectionState=h;for(const l of this.connectionStateSubscribers.values())l(h)}})}),f(this,"mark",h=>{this.debug&&Jt(h,this.sessionId)}),typeof e=="object")throw new Error("Passing a ClientConfig object is no longer supported. Pass the URL of the Convex deployment as a string directly.");n?.skipConvexDeploymentUrlCheck!==!0&&je(e),n={...n};const i=n.authRefreshTokenLeewaySeconds??2;let r=n.webSocketConstructor;if(!r&&typeof WebSocket>"u")throw new Error("No WebSocket global variable defined! To use Convex in an environment without WebSocket try the HTTP client: https://docs.convex.dev/api/classes/browser.ConvexHttpClient");r=r||WebSocket,this.debug=n.reportDebugInfoToConvex??!1,this.address=e,this.logger=n.logger===!1?$e({verbose:n.verbose??!1}):n.logger!==!0&&n.logger?n.logger:Oe({verbose:n.verbose??!1});const o=e.search("://");if(o===-1)throw new Error("Provided address was not an absolute URL.");const c=e.substring(o+3),a=e.substring(0,o);let u;if(a==="http")u="ws";else if(a==="https")u="wss";else throw new Error(`Unknown parent protocol ${a}`);const g=`${u}://${c}/api/${fe}/sync`;this.state=new ut,this.remoteQuerySet=new we(h=>this.state.queryPath(h),this.logger),this.requestManager=new dt(this.logger,this.markConnectionStateDirty);const y=()=>{this.webSocketManager.pause(),this.state.pause()};this.authenticationManager=new Wt(this.state,{authenticate:h=>{const l=this.state.setAuth(h);return this.webSocketManager.sendMessage(l),l.baseVersion},stopSocket:()=>this.webSocketManager.stop(),tryRestartSocket:()=>this.webSocketManager.tryRestart(),pauseSocket:y,resumeSocket:()=>this.webSocketManager.resume(),clearAuth:()=>{this.clearAuth()}},{logger:this.logger,refreshTokenLeewaySeconds:i}),this.optimisticQueryResults=new St,this.addOnTransitionHandler(h=>{t(h.queries.map(l=>l.token))}),this._nextRequestId=0,this._sessionId=Lt();const{unsavedChangesWarning:q}=n;if(typeof window>"u"||typeof window.addEventListener>"u"){if(q===!0)throw new Error("unsavedChangesWarning requested, but window.addEventListener not found! Remove {unsavedChangesWarning: true} from Convex client options.")}else q!==!1&&window.addEventListener("beforeunload",h=>{if(this.requestManager.hasIncompleteRequests()){h.preventDefault();const l="Are you sure you want to leave? Your changes may not be saved.";return(h||window.event).returnValue=l,l}});this.webSocketManager=new Et(g,{onOpen:h=>{this.mark("convexWebSocketOpen"),this.webSocketManager.sendMessage({...h,type:"Connect",sessionId:this._sessionId,maxObservedTimestamp:this.maxObservedTimestamp});const l=new Set(this.remoteQuerySet.remoteQueryResults().keys());this.remoteQuerySet=new we(K=>this.state.queryPath(K),this.logger);const[A,ce]=this.state.restart(l);ce&&this.webSocketManager.sendMessage(ce),this.webSocketManager.sendMessage(A);for(const K of this.requestManager.restart())this.webSocketManager.sendMessage(K)},onResume:()=>{const[h,l]=this.state.resume();l&&this.webSocketManager.sendMessage(l),h&&this.webSocketManager.sendMessage(h);for(const A of this.requestManager.resume())this.webSocketManager.sendMessage(A)},onMessage:h=>{switch(this.firstMessageReceived||(this.firstMessageReceived=!0,this.mark("convexFirstMessageReceived"),this.reportMarks()),h.type){case"Transition":{this.observedTimestamp(h.endVersion.ts),this.authenticationManager.onTransition(h),this.remoteQuerySet.transition(h),this.state.transition(h);const l=this.requestManager.removeCompleted(this.remoteQuerySet.timestamp());this.notifyOnQueryResultChanges(l);break}case"MutationResponse":{h.success&&this.observedTimestamp(h.ts);const l=this.requestManager.onResponse(h);l!==null&&this.notifyOnQueryResultChanges(new Map([[l.requestId,l.result]]));break}case"ActionResponse":{this.requestManager.onResponse(h);break}case"AuthError":{this.authenticationManager.onAuthError(h);break}case"FatalError":{const l=ot(this.logger,h.error);throw this.webSocketManager.terminate(),l}}return{hasSyncedPastLastReconnect:this.hasSyncedPastLastReconnect()}},onServerDisconnectError:n.onServerDisconnectError},r,this.logger,this.markConnectionStateDirty,this.debug),this.mark("convexClientConstructed"),n.expectAuth&&y()}hasSyncedPastLastReconnect(){return this.requestManager.hasSyncedPastLastReconnect()||this.state.hasSyncedPastLastReconnect()}observedTimestamp(e){(this.maxObservedTimestamp===void 0||this.maxObservedTimestamp.lessThanOrEqual(e))&&(this.maxObservedTimestamp=e)}getMaxObservedTimestamp(){return this.maxObservedTimestamp}notifyOnQueryResultChanges(e){const t=this.remoteQuerySet.remoteQueryResults(),n=new Map;for(const[r,o]of t){const c=this.state.queryToken(r);if(c!==null){const a={result:o,udfPath:this.state.queryPath(r),args:this.state.queryArgs(r)};n.set(c,a)}}const i=this.optimisticQueryResults.ingestQueryResultsFromServer(n,new Set(e.keys()));this.handleTransition({queries:i.map(r=>{const o=this.optimisticQueryResults.rawQueryResult(r);return{token:r,modification:{kind:"Updated",result:o}}}),reflectedMutations:Array.from(e).map(([r,o])=>({requestId:r,result:o})),timestamp:this.remoteQuerySet.timestamp()})}handleTransition(e){for(const t of this._onTransitionFns.values())t(e)}addOnTransitionHandler(e){const t=this._transitionHandlerCounter++;return this._onTransitionFns.set(t,e),()=>this._onTransitionFns.delete(t)}getCurrentAuthClaims(){const e=this.state.getAuth();let t={};if(e&&e.tokenType==="User")try{t=e?Ee(e.value):{}}catch{t={}}else return;return{token:e.value,decoded:t}}setAuth(e,t){this.authenticationManager.setConfig(e,t)}hasAuth(){return this.state.hasAuth()}setAdminAuth(e,t){const n=this.state.setAdminAuth(e,t);this.webSocketManager.sendMessage(n)}clearAuth(){const e=this.state.clearAuth();this.webSocketManager.sendMessage(e)}subscribe(e,t,n){const i=R(t),{modification:r,queryToken:o,unsubscribe:c}=this.state.subscribe(e,i,n?.journal,n?.componentPath);return r!==null&&this.webSocketManager.sendMessage(r),{queryToken:o,unsubscribe:()=>{const a=c();a&&this.webSocketManager.sendMessage(a)}}}localQueryResult(e,t){const n=R(t),i=_(e,n);return this.optimisticQueryResults.queryResult(i)}localQueryResultByToken(e){return this.optimisticQueryResults.queryResult(e)}hasLocalQueryResultByToken(e){return this.optimisticQueryResults.hasQueryResult(e)}localQueryLogs(e,t){const n=R(t),i=_(e,n);return this.optimisticQueryResults.queryLogs(i)}queryJournal(e,t){const n=R(t),i=_(e,n);return this.state.queryJournal(i)}connectionState(){const e=this.webSocketManager.connectionState();return{hasInflightRequests:this.requestManager.hasInflightRequests(),isWebSocketConnected:e.isConnected,hasEverConnected:e.hasEverConnected,connectionCount:e.connectionCount,connectionRetries:e.connectionRetries,timeOfOldestInflightRequest:this.requestManager.timeOfOldestInflightRequest(),inflightMutations:this.requestManager.inflightMutations(),inflightActions:this.requestManager.inflightActions()}}subscribeToConnectionState(e){const t=this.nextConnectionStateSubscriberId++;return this.connectionStateSubscribers.set(t,e),()=>{this.connectionStateSubscribers.delete(t)}}async mutation(e,t,n){const i=await this.mutationInternal(e,t,n);if(!i.success)throw i.errorData!==void 0?re(i,new ie($("mutation",e,i))):new Error($("mutation",e,i));return i.value}async mutationInternal(e,t,n,i){const{mutationPromise:r}=this.enqueueMutation(e,t,n,i);return r}enqueueMutation(e,t,n,i){const r=R(t);this.tryReportLongDisconnect();const o=this.nextRequestId;if(this._nextRequestId++,n!==void 0){const g=n.optimisticUpdate;if(g!==void 0){const y=l=>{g(l,r)instanceof Promise&&this.logger.warn("Optimistic update handler returned a Promise. Optimistic updates should be synchronous.")},h=this.optimisticQueryResults.applyOptimisticUpdate(y,o).map(l=>{const A=this.localQueryResultByToken(l);return{token:l,modification:{kind:"Updated",result:A===void 0?void 0:{success:!0,value:A,logLines:[]}}}});this.handleTransition({queries:h,reflectedMutations:[],timestamp:this.remoteQuerySet.timestamp()})}}const c={type:"Mutation",requestId:o,udfPath:e,componentPath:i,args:[k(r)]},a=this.webSocketManager.sendMessage(c),u=this.requestManager.request(c,a);return{requestId:o,mutationPromise:u}}async action(e,t){const n=await this.actionInternal(e,t);if(!n.success)throw n.errorData!==void 0?re(n,new ie($("action",e,n))):new Error($("action",e,n));return n.value}async actionInternal(e,t,n){const i=R(t),r=this.nextRequestId;this._nextRequestId++,this.tryReportLongDisconnect();const o={type:"Action",requestId:r,udfPath:e,componentPath:n,args:[k(i)]},c=this.webSocketManager.sendMessage(o);return this.requestManager.request(o,c)}async close(){return this.authenticationManager.stop(),this.webSocketManager.terminate()}get url(){return this.address}get nextRequestId(){return this._nextRequestId}get sessionId(){return this._sessionId}reportMarks(){if(this.debug){const e=Ht(this.sessionId);this.webSocketManager.sendMessage({type:"Event",eventType:"ClientConnect",event:e})}}tryReportLongDisconnect(){if(!this.debug)return;const e=this.connectionState().timeOfOldestInflightRequest;if(e===null||Date.now()-e.getTime()<=60*1e3)return;const t=`${this.address}/api/debug_event`;fetch(t,{method:"POST",headers:{"Content-Type":"application/json","Convex-Client":`npm-${fe}`},body:JSON.stringify({event:"LongWebsocketDisconnect"})}).then(n=>{n.ok||this.logger.warn("Analytics request failed with response:",n.body)}).catch(n=>{this.logger.warn("Analytics response failed with error:",n)})}}function ee(s){if(typeof s!="object"||s===null||!Array.isArray(s.page)||typeof s.isDone!="boolean"||typeof s.continueCursor!="string")throw new Error(`Not a valid paginated query result: ${s?.toString()}`);return s}var Yt=Object.defineProperty,Zt=(s,e,t)=>e in s?Yt(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,ke=(s,e,t)=>Zt(s,typeof e!="symbol"?e+"":e,t);class es{constructor(e,t){this.client=e,this.onTransition=t,ke(this,"paginatedQuerySet",new Map),ke(this,"lastTransitionTs"),this.lastTransitionTs=p.fromNumber(0),this.client.addOnTransitionHandler(n=>this.onBaseTransition(n))}subscribe(e,t,n){const i=I(e),r=ye(i,t,n),o=()=>this.removePaginatedQuerySubscriber(r),c=this.paginatedQuerySet.get(r);return c?(c.numSubscribers+=1,{paginatedQueryToken:r,unsubscribe:o}):(this.paginatedQuerySet.set(r,{token:r,canonicalizedUdfPath:i,args:t,numSubscribers:1,options:{initialNumItems:n.initialNumItems},nextPageKey:0,pageKeys:[],pageKeyToQuery:new Map,ongoingSplits:new Map,skip:!1,id:n.id}),this.addPageToPaginatedQuery(r,null,n.initialNumItems),{paginatedQueryToken:r,unsubscribe:o})}localQueryResult(e,t,n){const i=I(e),r=ye(i,t,n);return this.localQueryResultByToken(r)}localQueryResultByToken(e){const t=this.paginatedQuerySet.get(e);if(!t)return;const n=this.activePageQueryTokens(t);if(n.length===0)return{results:[],status:"LoadingFirstPage",loadMore:a=>this.loadMoreOfPaginatedQuery(e,a)};let i=[],r=!1,o=!1;for(const a of n){const u=this.client.localQueryResultByToken(a);if(u===void 0){r=!0,o=!1;continue}const g=ee(u);i=i.concat(g.page),o=!!g.isDone}let c;return r?c=i.length===0?"LoadingFirstPage":"LoadingMore":o?c="Exhausted":c="CanLoadMore",{results:i,status:c,loadMore:a=>this.loadMoreOfPaginatedQuery(e,a)}}onBaseTransition(e){const t=e.queries.map(o=>o.token),n=this.queriesContainingTokens(t);let i=[];n.length>0&&(this.processPaginatedQuerySplits(n,o=>this.client.localQueryResultByToken(o)),i=n.map(o=>({token:o,modification:{kind:"Updated",result:this.localQueryResultByToken(o)}})));const r={...e,paginatedQueries:i};this.onTransition(r)}loadMoreOfPaginatedQuery(e,t){this.mustGetPaginatedQuery(e);const n=this.queryTokenForLastPageOfPaginatedQuery(e),i=this.client.localQueryResultByToken(n);if(!i)return!1;const r=ee(i);if(r.isDone)return!1;this.addPageToPaginatedQuery(e,r.continueCursor,t);const o={timestamp:this.lastTransitionTs,reflectedMutations:[],queries:[],paginatedQueries:[{token:e,modification:{kind:"Updated",result:this.localQueryResultByToken(e)}}]};return this.onTransition(o),!0}queriesContainingTokens(e){if(e.length===0)return[];const t=[],n=new Set(e);for(const[i,r]of this.paginatedQuerySet)for(const o of this.allQueryTokens(r))if(n.has(o)){t.push(i);break}return t}processPaginatedQuerySplits(e,t){for(const n of e){const i=this.mustGetPaginatedQuery(n),{ongoingSplits:r,pageKeyToQuery:o,pageKeys:c}=i;for(const[a,[u,g]]of r)t(o.get(u).queryToken)!==void 0&&t(o.get(g).queryToken)!==void 0&&this.completePaginatedQuerySplit(i,a,u,g);for(const a of c){if(r.has(a))continue;const u=o.get(a).queryToken,g=t(u);if(!g)continue;const y=ee(g);y.splitCursor&&(y.pageStatus==="SplitRecommended"||y.pageStatus==="SplitRequired"||y.page.length>i.options.initialNumItems*2)&&this.splitPaginatedQueryPage(i,a,y.splitCursor,y.continueCursor)}}}splitPaginatedQueryPage(e,t,n,i){const r=e.nextPageKey++,o=e.nextPageKey++,c={cursor:i,numItems:e.options.initialNumItems,id:e.id},a=this.client.subscribe(e.canonicalizedUdfPath,{...e.args,paginationOpts:{...c,cursor:null,endCursor:n}});e.pageKeyToQuery.set(r,a);const u=this.client.subscribe(e.canonicalizedUdfPath,{...e.args,paginationOpts:{...c,cursor:n,endCursor:i}});e.pageKeyToQuery.set(o,u),e.ongoingSplits.set(t,[r,o])}addPageToPaginatedQuery(e,t,n){const i=this.mustGetPaginatedQuery(e),r=i.nextPageKey++,o={cursor:t,numItems:n,id:i.id},c={...i.args,paginationOpts:o},a=this.client.subscribe(i.canonicalizedUdfPath,c);return i.pageKeys.push(r),i.pageKeyToQuery.set(r,a),a}removePaginatedQuerySubscriber(e){const t=this.paginatedQuerySet.get(e);if(t&&(t.numSubscribers-=1,!(t.numSubscribers>0))){for(const n of t.pageKeyToQuery.values())n.unsubscribe();this.paginatedQuerySet.delete(e)}}completePaginatedQuerySplit(e,t,n,i){const r=e.pageKeyToQuery.get(t);e.pageKeyToQuery.delete(t);const o=e.pageKeys.indexOf(t);e.pageKeys.splice(o,1,n,i),e.ongoingSplits.delete(t),r.unsubscribe()}activePageQueryTokens(e){return e.pageKeys.map(t=>e.pageKeyToQuery.get(t).queryToken)}allQueryTokens(e){return Array.from(e.pageKeyToQuery.values()).map(t=>t.queryToken)}queryTokenForLastPageOfPaginatedQuery(e){const t=this.mustGetPaginatedQuery(e),n=t.pageKeys[t.pageKeys.length-1];if(n===void 0)throw new Error(`No pages for paginated query ${e}`);return t.pageKeyToQuery.get(n).queryToken}mustGetPaginatedQuery(e){const t=this.paginatedQuerySet.get(e);if(!t)throw new Error("paginated query no longer exists for token "+e);return t}}function ts({getCurrentValue:s,subscribe:e}){const[t,n]=C.useState(()=>({getCurrentValue:s,subscribe:e,value:s()}));let i=t.value;return(t.getCurrentValue!==s||t.subscribe!==e)&&(i=s(),n({getCurrentValue:s,subscribe:e,value:i})),C.useEffect(()=>{let r=!1;const o=()=>{r||n(a=>{if(a.getCurrentValue!==s||a.subscribe!==e)return a;const u=s();return a.value===u?a:{...a,value:u}})},c=e(o);return o(),()=>{r=!0,c()}},[s,e]),i}var ss=Object.defineProperty,ns=(s,e,t)=>e in s?ss(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,T=(s,e,t)=>ns(s,typeof e!="symbol"?e+"":e,t);const is=5e3;if(typeof oe>"u")throw new Error("Required dependency 'react' not found");class rs{constructor(e,t){if(T(this,"address"),T(this,"cachedSync"),T(this,"cachedPaginatedQueryClient"),T(this,"listeners"),T(this,"options"),T(this,"closed",!1),T(this,"_logger"),T(this,"adminAuth"),T(this,"fakeUserIdentity"),e===void 0)throw new Error("No address provided to ConvexReactClient.\nIf trying to deploy to production, make sure to follow all the instructions found at https://docs.convex.dev/production/hosting/\nIf running locally, make sure to run `convex dev` and ensure the .env.local file is populated.");if(typeof e!="string")throw new Error(`ConvexReactClient requires a URL like 'https://happy-otter-123.convex.cloud', received something of type ${typeof e} instead.`);if(!e.includes("://"))throw new Error("Provided address was not an absolute URL.");this.address=e,this.listeners=new Map,this._logger=t?.logger===!1?$e({verbose:t?.verbose??!1}):t?.logger!==!0&&t?.logger?t.logger:Oe({verbose:t?.verbose??!1}),this.options={...t,logger:this._logger}}get url(){return this.address}get sync(){if(this.closed)throw new Error("ConvexReactClient has already been closed.");return this.cachedSync?this.cachedSync:(this.cachedSync=new Xt(this.address,()=>{},this.options),this.adminAuth&&this.cachedSync.setAdminAuth(this.adminAuth,this.fakeUserIdentity),this.cachedPaginatedQueryClient=new es(this.cachedSync,e=>this.handleTransition(e)),this.cachedSync)}get paginatedQueryClient(){if(this.sync,this.cachedPaginatedQueryClient)return this.cachedPaginatedQueryClient;throw new Error("Should already be instantiated")}setAuth(e,t){if(typeof e=="string")throw new Error("Passing a string to ConvexReactClient.setAuth is no longer supported, please upgrade to passing in an async function to handle reauthentication.");this.sync.setAuth(e,t??(()=>{}))}clearAuth(){this.sync.clearAuth()}setAdminAuth(e,t){if(this.adminAuth=e,this.fakeUserIdentity=t,this.closed)throw new Error("ConvexReactClient has already been closed.");this.cachedSync&&this.sync.setAdminAuth(e,t)}watchQuery(e,...t){const[n,i]=t,r=b(e);return{onUpdate:o=>{const{queryToken:c,unsubscribe:a}=this.sync.subscribe(r,n,i),u=this.listeners.get(c);return u!==void 0?u.add(o):this.listeners.set(c,new Set([o])),()=>{if(this.closed)return;const g=this.listeners.get(c);g.delete(o),g.size===0&&this.listeners.delete(c),a()}},localQueryResult:()=>{if(this.cachedSync)return this.cachedSync.localQueryResult(r,n)},localQueryLogs:()=>{if(this.cachedSync)return this.cachedSync.localQueryLogs(r,n)},journal:()=>{if(this.cachedSync)return this.cachedSync.queryJournal(r,n)}}}prewarmQuery(e){const t=e.extendSubscriptionFor??is,i=this.watchQuery(e.query,e.args||{}).onUpdate(()=>{});setTimeout(i,t)}watchPaginatedQuery(e,t,n){const i=b(e);return{onUpdate:r=>{const{paginatedQueryToken:o,unsubscribe:c}=this.paginatedQueryClient.subscribe(i,t||{},n),a=this.listeners.get(o);return a!==void 0?a.add(r):this.listeners.set(o,new Set([r])),()=>{if(this.closed)return;const u=this.listeners.get(o);u.delete(r),u.size===0&&this.listeners.delete(o),c()}},localQueryResult:()=>this.paginatedQueryClient.localQueryResult(i,t,n)}}mutation(e,...t){const[n,i]=t,r=b(e);return this.sync.mutation(r,n,i)}action(e,...t){const n=b(e);return this.sync.action(n,...t)}query(e,...t){const n=this.watchQuery(e,...t),i=n.localQueryResult();return i!==void 0?Promise.resolve(i):new Promise((r,o)=>{const c=n.onUpdate(()=>{c();try{r(n.localQueryResult())}catch(a){o(a)}})})}connectionState(){return this.sync.connectionState()}subscribeToConnectionState(e){return this.sync.subscribeToConnectionState(e)}get logger(){return this._logger}async close(){if(this.closed=!0,this.listeners=new Map,this.cachedPaginatedQueryClient&&(this.cachedPaginatedQueryClient=void 0),this.cachedSync){const e=this.cachedSync;this.cachedSync=void 0,await e.close()}}handleTransition(e){const t=e.queries.map(i=>i.token),n=e.paginatedQueries.map(i=>i.token);this.transition([...t,...n])}transition(e){for(const t of e){const n=this.listeners.get(t);if(n)for(const i of n)i()}}}const Le=oe.createContext(void 0);function os(){return C.useContext(Le)}const as=({client:s,children:e})=>oe.createElement(Le.Provider,{value:s},e);function ms(s,...e){const t=e[0]==="skip",n=e[0]==="skip"?{}:R(e[0]),i=typeof s=="string"?pt(s):s,r=b(i),o=C.useMemo(()=>t?{}:{query:{query:i,args:n}},[JSON.stringify(k(n)),r,t]),a=ls(o).query;if(a instanceof Error)throw a;return a}var cs=Object.defineProperty,us=(s,e,t)=>e in s?cs(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,te=(s,e,t)=>us(s,typeof e!="symbol"?e+"":e,t);class hs{constructor(e){te(this,"createWatch"),te(this,"queries"),te(this,"listeners"),this.createWatch=e,this.queries={},this.listeners=new Set}setQueries(e){for(const t of Object.keys(e)){const{query:n,args:i,paginationOptions:r}=e[t];if(b(n),this.queries[t]===void 0)this.addQuery(t,n,i,r?{paginationOptions:r}:{});else{const o=this.queries[t];(b(n)!==b(o.query)||JSON.stringify(k(i))!==JSON.stringify(k(o.args))||JSON.stringify(r)!==JSON.stringify(o.paginationOptions))&&(this.removeQuery(t),this.addQuery(t,n,i,r?{paginationOptions:r}:{}))}}for(const t of Object.keys(this.queries))e[t]===void 0&&this.removeQuery(t)}subscribe(e){return this.listeners.add(e),()=>{this.listeners.delete(e)}}getLocalResults(e){const t={};for(const n of Object.keys(e)){const{query:i,args:r}=e[n],o=e[n].paginationOptions;b(i);const c=this.createWatch(i,r,o?{paginationOptions:o}:{});let a;try{a=c.localQueryResult()}catch(u){if(u instanceof Error)a=u;else throw u}t[n]=a}return t}setCreateWatch(e){this.createWatch=e;for(const t of Object.keys(this.queries)){const{query:n,args:i,watch:r,paginationOptions:o}=this.queries[t],c="journal"in r?r.journal():void 0;this.removeQuery(t),this.addQuery(t,n,i,{...c?{journal:c}:[],...o?{paginationOptions:o}:{}})}}destroy(){for(const e of Object.keys(this.queries))this.removeQuery(e);this.listeners=new Set}addQuery(e,t,n,{paginationOptions:i,journal:r}){if(this.queries[e]!==void 0)throw new Error(`Tried to add a new query with identifier ${e} when it already exists.`);const o=this.createWatch(t,n,{...r?{journal:r}:[],...i?{paginationOptions:i}:{}}),c=o.onUpdate(()=>this.notifyListeners());this.queries[e]={query:t,args:n,watch:o,unsubscribe:c,...i?{paginationOptions:i}:{}}}removeQuery(e){const t=this.queries[e];if(t===void 0)throw new Error(`No query found with identifier ${e}.`);t.unsubscribe(),delete this.queries[e]}notifyListeners(){for(const e of this.listeners)e()}}function ls(s){const e=os();if(e===void 0)throw new Error("Could not find Convex client! `useQuery` must be used in the React component tree under `ConvexProvider`. Did you forget it? See https://docs.convex.dev/quick-start#set-up-convex-in-your-react-app");const t=C.useMemo(()=>(n,i,{journal:r,paginationOptions:o})=>o?e.watchPaginatedQuery(n,i,o):e.watchQuery(n,i,r?{journal:r}:{}),[e]);return ds(s,t)}function ds(s,e){const[t]=C.useState(()=>new hs(e));t.createWatch!==e&&t.setCreateWatch(e),C.useEffect(()=>()=>t.destroy(),[t]);const n=C.useMemo(()=>({getCurrentValue:()=>t.getLocalResults(s),subscribe:i=>(t.setQueries(s),t.subscribe(i))}),[t,s]);return ts(n)}const fs="https://strong-chihuahua-579.convex.cloud",Te=new rs(fs);function ws({children:s}){return Te?H.jsx(as,{client:Te,children:s}):H.jsx(H.Fragment,{children:s})}function Ne(s,e){const t={get(n,i){if(typeof i=="string"){const r=[...e,i];return Ne(s,r)}else if(i===Pe){if(e.length<1){const r=[s,...e].join(".");throw new Error(`API path is expected to be of the form \`${s}.childComponent.functionName\`. Found: \`${r}\``)}return"_reference/childComponent/"+e.join("/")}else return}};return new Proxy({},t)}const gs=()=>Ne("components",[]),bs=mt;gs();export{ws as C,bs as a,os as b,ms as u};
